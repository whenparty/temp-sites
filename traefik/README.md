# Traefik Router for Temp Sites

This directory contains the Traefik router configuration that acts as the HTTP router for all `*.when.party` subdomains.

## Architecture

```
Internet → Cloudflare → Nginx (TLS:443) → Traefik (HTTP:8000) → Project Containers
```

- **Nginx** terminates TLS and forwards all `*.when.party` requests to Traefik
- **Traefik** uses Docker labels to dynamically route requests to project containers
- **Projects** join the `wp_tempsites` network and declare their routing via labels

## Deployment

### Automated Deployment

#### Setup GitHub Secrets

Add these secrets to your GitHub repository (Settings → Secrets and variables → Actions):

```
TRAEFIK_DASHBOARD_USER=admin
TRAEFIK_DASHBOARD_PASSWORD=your-secure-password
```

#### Deploy

Push changes to `traefik/` directory or manually trigger the workflow:

```bash
# Commit changes
git add traefik/
git commit -m "Update Traefik configuration"
git push origin main

# Or trigger manually via GitHub Actions UI
# Go to: Actions → Deploy Traefik Router → Run workflow
```

The workflow will:

1. Generate htpasswd hash from your secrets
2. Deploy to VPS (ensuring `.env.local` exists with the default loopback allow list)
3. Create `.env` file with credentials
4. Start Traefik container

### Verify Traefik is Working

```bash
# From the nginx proxy container, test that Traefik responds
docker exec nginx curl -H "Host: test.when.party" http://traefik-tempsites:8000
# Expected: 404 (means Traefik is running but no route matches)
# (Install curl once if needed: docker exec nginx apk add --no-cache curl)

# Check Traefik logs
docker logs -f traefik-tempsites

# Access dashboard (after DNS is configured)
# Visit: https://traefik.when.party
# Login with credentials from TRAEFIK_DASHBOARD_USER/PASSWORD
```

## Dashboard Access

The Traefik dashboard is available at `https://traefik.when.party` (after DNS configuration).

### DNS Setup

Add a DNS record in Cloudflare:

```
Type    Name       Content           Proxy Status
A       traefik    YOUR_VPS_IP       Proxied (☁️)
```

Or use a CNAME to `when.party` if you already have the wildcard pointing at the apex.

### Dashboard Features

- Real-time routing table
- Service health status
- Request metrics
- Configuration overview

### Disable Dashboard (Production)

For production, you may want to disable the dashboard:

1. Remove the dashboard labels from `docker-compose.yml`
2. Or keep it enabled but restrict access via the `dashboard-ipallow` middleware:
   - SSH to the VPS and edit `/opt/services/whenparty/tempsites/traefik/.env.local`, setting `TRAEFIK_DASHBOARD_IP_ALLOW` to the CIDR(s) you trust (default `127.0.0.1/32` blocks external access).
   - Run `docker compose up -d` in that directory so Traefik reloads the new allow list.

## Configuration Details

### Provider Settings

- **Docker Provider**: Traefik watches Docker for containers with specific labels
- **Network**: Only containers on `tempsites` network are discovered
- **Exposed by Default**: `false` - containers must explicitly enable Traefik with labels

### Entrypoint

- **Port 8000**: HTTP-only (TLS is handled by nginx)
- **Not exposed to internet**: Only accessible via nginx proxy or localhost

### Logging

Logs are stored in a Docker volume `traefik-logs`:

- `/var/log/traefik/access.log` - HTTP access logs
- `/var/log/traefik/traefik.log` - Traefik application logs

To view logs:

```bash
docker exec traefik-tempsites cat /var/log/traefik/access.log
docker exec traefik-tempsites cat /var/log/traefik/traefik.log

# Or view real-time
docker logs -f traefik-tempsites
```

### Security: Dashboard Authentication

Dashboard uses HTTP Basic Authentication with credentials stored as:

- **GitHub Secrets** (automated deployment) - `TRAEFIK_DASHBOARD_USER` and `TRAEFIK_DASHBOARD_PASSWORD`
- **.env file** (manual deployment) - `TRAEFIK_DASHBOARD_AUTH`

The htpasswd hash is generated automatically during deployment (GitHub Actions) and never committed to git.

#### Rotating Dashboard Credentials

**Automated (GitHub Actions):**

1. Update secrets in GitHub: Settings → Secrets → Actions
2. Trigger workflow: Actions → Deploy Traefik Router → Run workflow

**Manual:**

```bash
# Generate new hash
htpasswd -nb admin new-password
# Escape $ as $$

# Update .env file
cd /opt/services/whenparty/tempsites/traefik
nano .env
# Update TRAEFIK_DASHBOARD_AUTH value

# Restart Traefik
docker compose restart traefik
```

### Dashboard IP Allow List

The compose file loads two environment sources:

- `.env` – generated by the deployment workflow with the dashboard auth hash (overwritten on every deploy)
- `.env.local` – local override created automatically on the VPS if missing; defaults to `TRAEFIK_DASHBOARD_IP_ALLOW=127.0.0.1/32` so the dashboard stays closed to the internet

To grant temporary access:

```bash
ssh user@your-vps
cd /opt/services/whenparty/tempsites/traefik
nano .env.local                 # Set TRAEFIK_DASHBOARD_IP_ALLOW=144.134.111.192/32 (example)
docker compose up -d            # Traefik restarts and applies the new allow list
```

Future deployments leave `.env.local` untouched, so your allow list persists until you edit it again.

## How Projects Connect

Projects declare their routing via Docker labels in their `compose.yml`:

```yaml
services:
  app:
    image: my-image
    networks:
      - tempsites
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.myapp.rule=Host(`myapp.when.party`)"
      - "traefik.http.routers.myapp.entrypoints=web"
      - "traefik.http.services.myapp.loadbalancer.server.port=80"

networks:
  tempsites:
    external: true
```

When the container starts, Traefik automatically:

1. Discovers it via Docker socket
2. Reads the labels
3. Creates routing rules
4. Routes requests to the container

## Troubleshooting

### Traefik not starting

```bash
# Check logs
docker logs traefik-tempsites

# Check if .env file exists and has credentials
cat /opt/services/whenparty/tempsites/traefik/.env

# Check network exists
docker network inspect wp_tempsites

# Verify Docker socket is accessible
docker exec traefik-tempsites ls -la /var/run/docker.sock
```

### Dashboard authentication not working

```bash
# Verify .env has the auth hash
cd /opt/services/whenparty/tempsites/traefik
cat .env | grep TRAEFIK_DASHBOARD_AUTH

# Regenerate if needed (htpasswd -nb admin password)
# Update .env
docker compose restart traefik
```

### Dashboard access forbidden (HTTP 403)

```bash
# Check current allow list
cd /opt/services/whenparty/tempsites/traefik
cat .env.local | grep TRAEFIK_DASHBOARD_IP_ALLOW

# Add your public IP (/32) and reapply
nano .env.local                         # e.g. TRAEFIK_DASHBOARD_IP_ALLOW=144.134.111.192/32
docker compose up -d                    # Traefik restarts with the new allow list
```

### Routes not working

```bash
# Check if Traefik discovered the container
docker logs traefik-tempsites | grep "myproject"

# Verify container is on wp_tempsites network
docker network inspect wp_tempsites

# Check container labels
docker inspect myproject-container | grep -A 10 Labels

# Test Traefik directly (bypass nginx)
docker exec nginx curl -H "Host: myproject.when.party" http://traefik-tempsites:8000
# (Install curl once if needed: docker exec nginx apk add --no-cache curl)
```

### 404 errors

```bash
# Check Traefik logs for routing decisions
docker logs -f traefik-tempsites

# Verify the Host header matches the router rule
# Rule: Host(`myapp.when.party`)
# Request must have: Host: myapp.when.party
```

### Container not discovered

Ensure:

1. Container is on `wp_tempsites` network
2. Container has `traefik.enable=true` label
3. Container is running (not stopped or restarting)
4. Traefik container is running

## Security Notes

### Docker Socket Access

Traefik has read-only access to `/var/run/docker.sock`. This is required for service discovery but poses a security risk.

**Current Mitigation:**

- Mount is read-only (`:ro`)
- Traefik runs as non-root user (default in official image)

**Future Enhancement:**
Consider using [docker-socket-proxy](https://github.com/Tecnativa/docker-socket-proxy) for production:

```yaml
# Add to docker-compose.yml
services:
  socket-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: docker-socket-proxy
    environment:
      CONTAINERS: 1
      NETWORKS: 1
      SERVICES: 0
      TASKS: 0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - socket-proxy

  traefik:
    # ... existing config ...
    environment:
      DOCKER_HOST: tcp://socket-proxy:2375
    # Remove docker.sock volume mount
```

### Network Isolation

- Traefik only routes to containers on `wp_tempsites` network
- Projects cannot access stable services on `wp_www`
- Projects cannot access each other (no inter-container communication)

### Credentials Storage

- **Never commit** .env files with credentials to git (.env is in .gitignore)
- Use GitHub Secrets for automated deployments
- Rotate credentials regularly (every 90 days recommended)

### Rate Limiting (Future Enhancement)

Consider adding Traefik middleware for rate limiting:

```yaml
labels:
  - "traefik.http.middlewares.rate-limit.ratelimit.average=100"
  - "traefik.http.middlewares.rate-limit.ratelimit.burst=50"
  - "traefik.http.routers.myapp.middlewares=rate-limit"
```

## Maintenance

### Updating Traefik

**Automated (GitHub Actions):**

```bash
git add traefik/docker-compose.yml
git commit -m "Update Traefik to v3.1"
git push origin main
```

**Manual:**

```bash
cd /opt/services/whenparty/tempsites/traefik
docker compose pull
docker compose up -d
```

### Viewing Logs

```bash
# Real-time logs
docker logs -f traefik-tempsites

# Last 100 lines
docker logs --tail 100 traefik-tempsites

# Access logs
docker exec traefik-tempsites tail -f /var/log/traefik/access.log
```

### Restarting Traefik

```bash
cd /opt/services/whenparty/tempsites/traefik
docker compose restart traefik
```

### Backup Configuration

```bash
# Backup .env file (contains credentials)
scp user@vps:/opt/services/whenparty/tempsites/traefik/.env ~/backups/traefik.env.backup

# Encrypt it
gpg --symmetric ~/backups/traefik.env.backup
rm ~/backups/traefik.env.backup  # Remove plaintext
```

## See Also

- [Traefik Documentation](https://doc.traefik.io/traefik/)
- [Docker Provider](https://doc.traefik.io/traefik/providers/docker/)
- [Traefik Routing](https://doc.traefik.io/traefik/routing/overview/)
- [Basic Auth Middleware](https://doc.traefik.io/traefik/middlewares/http/basicauth/)
