name: Deploy Traefik Router

on:
  push:
    branches: [main]
    paths:
      - 'traefik/**'
  workflow_dispatch:
    inputs:
      dashboard_ip_allow:
        description: 'IP whitelist for dashboard (e.g., 0.0.0.0/0 or 1.2.3.4/32)'
        required: false
        default: ''

env:
  DEPLOY_ROOT: /opt/services/whenparty/tempsites

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Copy Traefik files to VPS
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_DEPLOY_KEY }}
          source: "traefik/**"
          target: "${{ env.DEPLOY_ROOT }}/traefik/"
          strip_components: 1

      - name: Generate dashboard auth hash
        id: auth
        run: |
          set -euo pipefail

          # Install htpasswd
          sudo apt-get update
          sudo apt-get install -y apache2-utils

          # Generate hash from secrets
          HASH=$(htpasswd -nb "${{ secrets.TRAEFIK_DASHBOARD_USER }}" "${{ secrets.TRAEFIK_DASHBOARD_PASSWORD }}")

          # Escape $ for docker-compose ($ becomes $$)
          ESCAPED=$(echo "$HASH" | sed 's/\$/\$\$/g')

          # Output as GitHub Actions variable (mask it for security)
          echo "::add-mask::$ESCAPED"
          echo "hash=$ESCAPED" >> "$GITHUB_OUTPUT"

      - name: Deploy Traefik to VPS
        uses: appleboy/ssh-action@v1.2.0
        env:
          TRAEFIK_DASHBOARD_AUTH: ${{ steps.auth.outputs.hash }}
          DASHBOARD_IP_ALLOW: ${{ github.event.inputs.dashboard_ip_allow }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_DEPLOY_KEY }}
          envs: TRAEFIK_DASHBOARD_AUTH,DASHBOARD_IP_ALLOW
          script: |
            set -euo pipefail

            DEPLOY_ROOT="${{ env.DEPLOY_ROOT }}"
            TRAEFIK_DIR="$DEPLOY_ROOT/traefik"

            # Ensure deployment directory exists (scp step creates it if missing)
            mkdir -p "$TRAEFIK_DIR"

            cd "$TRAEFIK_DIR"

            # Create .env file with auth credentials
            printf 'TRAEFIK_DASHBOARD_AUTH=%s\n' "$TRAEFIK_DASHBOARD_AUTH" > .env

            chmod 600 .env

            # Manage .env.local for IP whitelist
            if [ -n "$DASHBOARD_IP_ALLOW" ]; then
              # Workflow input provided - update/create .env.local with specified IP allow list
              printf 'TRAEFIK_DASHBOARD_IP_ALLOW=%s\n' "$DASHBOARD_IP_ALLOW" > .env.local
              chmod 600 .env.local
              echo "Updated .env.local with IP allow list: $DASHBOARD_IP_ALLOW"
            elif [ ! -f ".env.local" ]; then
              # No workflow input and .env.local doesn't exist - create with secure default
              printf 'TRAEFIK_DASHBOARD_IP_ALLOW=127.0.0.1/32\n' > .env.local
              chmod 600 .env.local
              echo "Created .env.local with default (localhost only)"
            else
              echo "Preserving existing .env.local configuration"
            fi

            # Ensure wp_tempsites network exists
            docker network inspect wp_tempsites >/dev/null 2>&1 || docker network create wp_tempsites

            # Export environment variables so docker-compose interpolation picks them up
            # Export auth credentials from .env
            if [ -f ".env" ]; then
              if AUTH_LINE=$(grep -m1 '^TRAEFIK_DASHBOARD_AUTH=' .env); then
                AUTH_VALUE=${AUTH_LINE#*=}
                export TRAEFIK_DASHBOARD_AUTH="$AUTH_VALUE"
              fi
            fi

            # Export dashboard allow list from .env.local
            if [ -f ".env.local" ]; then
              if ALLOW_LINE=$(grep -m1 '^TRAEFIK_DASHBOARD_IP_ALLOW=' .env.local); then
                ALLOW_VALUE=${ALLOW_LINE#*=}
                export TRAEFIK_DASHBOARD_IP_ALLOW="$ALLOW_VALUE"
              fi
            fi

            # Deploy Traefik
            docker compose pull
            docker compose up -d

            # Verify it's running
            sleep 5
            docker ps | grep traefik-tempsites || {
              echo "Error: Traefik container not running"
              docker logs traefik-tempsites
              exit 1
            }

            echo "Traefik deployed successfully"
            docker logs --tail 20 traefik-tempsites
